# BCE预测服务器内存监控指南

## 配置修改完成

✅ **已完成修改1：默认使用CPU模式**  
- 修改了 `config.py` 文件，将 `DEFAULT_DEVICE_ID` 从 `"0"` 改为 `"-1"`
- 现在服务器默认使用CPU模式运行，无需GPU

## 内存监控脚本使用方法

### 方法1：自动启动服务器并监控（推荐）

```bash
# 进入项目目录
cd src/bce/website

# 运行完整测试（启动服务器+监控内存）
python memory_monitor.py --mode test --duration 600

# 参数说明：
# --mode test: 自动启动服务器并监控
# --duration 600: 监控10分钟（600秒）
# --port 8000: 使用8000端口（可选）
```

### 方法2：手动启动服务器，单独监控

```bash
# 终端1：启动服务器
python run_server.py --preload

# 终端2：启动内存监控
python memory_monitor.py --mode monitor --interval 1.0

# 在浏览器中访问 http://localhost:8000 进行预测测试
# 按 Ctrl+C 停止监控
```

### 监控报告内容

脚本会监控以下内容：

1. **系统内存使用**
   - 峰值使用量（MB和百分比）
   - 平均使用量

2. **服务器进程内存使用**
   - 峰值RSS内存
   - 平均RSS内存

3. **所有Python进程总内存**
   - 峰值总内存使用
   - 平均总内存使用

### 测试建议

为了获得准确的内存使用数据，建议：

1. **预测测试步骤**：
   - 启动监控后，在浏览器中打开 http://localhost:8000
   - 上传一个PDB文件（建议使用中等大小的蛋白质，如200-500个残基）
   - 运行完整的预测流程
   - 查看3D可视化结果
   - 重复2-3次预测以获取稳定数据

2. **监控时间**：
   - 建议监控10-15分钟
   - 包含至少2-3次完整预测过程

3. **系统环境**：
   - 关闭其他大型应用程序
   - 确保系统有足够的可用内存

### 输出文件

- **日志文件**：`memory_log_YYYYMMDD_HHMMSS.json`
  - 包含详细的时间序列数据
  - 可用于后续分析

- **控制台输出**：
  - 实时显示峰值内存使用
  - 测试完成后显示详细摘要

### 示例输出

```
============================================================
内存使用摘要报告
============================================================
监控时长: 600.0 秒
数据点数: 600

系统内存使用:
  峰值使用: 12543.2 MB (78.4%)
  平均使用: 11876.5 MB (74.2%)

当前进程内存使用:
  峰值RSS: 45.2 MB
  平均RSS: 42.8 MB

服务器进程内存使用:
  峰值RSS: 2847.6 MB
  平均RSS: 2156.3 MB

所有Python进程总内存使用:
  峰值总计: 2892.8 MB
  平均总计: 2199.1 MB

详细数据已保存到: memory_log_20250103_143022.json
============================================================
```

### 快速开始

最简单的测试方式：

```bash
# 一条命令完成所有测试
cd src/bce/website && python memory_monitor.py --mode test --duration 300
```

然后在浏览器中访问 http://localhost:8000 进行预测测试即可。

### 注意事项

1. **依赖包**：确保已安装 `psutil` 包
   ```bash
   pip install psutil
   ```

2. **权限**：监控脚本需要读取进程信息的权限

3. **CPU模式**：现在默认使用CPU模式，预测时间会比GPU模式长，但内存使用更稳定

4. **ESM-C API**：使用ESM-C API获取蛋白质嵌入，无需本地GPU加速 